using TData.Configuration;
using TData.Core.FluentApi;
using TData.Cache;

namespace TData.Tests
{
    public class InMemoryCacheTests : IDatabaseProvider
    {
        public string ConnectionString => Environment.GetEnvironmentVariable("SqlServerCnx") ?? "Data Source=localhost;Initial Catalog=tempdb;Persist Security Info=True;User ID=sa;Password=Mssql_Test;TrustServerCertificate=true;packet size=2048;ApplicationIntent=ReadOnly;Min Pool Size=32;Max Pool Size=64;Pooling=true";

        private static void CreateAndPopulateTable()
        {
            var dbContext = DbHub.Use("db1");
            var icon = File.ReadAllBytes(Path.Combine(".", "Content", "TDataIco.png"));

            dbContext.ExecuteBlock((db) =>
            {
                db.Execute("DROP TABLE IF EXISTS USERS");
                db.Execute("CREATE TABLE USERS(ID INT PRIMARY KEY IDENTITY(1,1), USER_TYPE_ID INT NOT NULL, NAME VARCHAR(50), STATE BIT, SALARY DECIMAL(15,2), BIRTHDAY DATE, USERCODE UniqueIdentifier, ICON VARBINARY(MAX))");

                //TODO: replace for bulk insert
                db.Insert(new UserNullableRecord(0, 3, "Sample 1", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 2", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 3", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 4", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 5", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 6", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 7", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 8", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 9", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 10", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 11", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 12", null, null, null, null, null));
                db.Insert(new UserNullableRecord(0, 3, "Sample 13", null, null, null, null, null));
            });
        }

        [OneTimeSetUp]
        public void Initialize()
        {
            DbConfig.Clear();
            var tableBuilder = new TableBuilder();
            var table = tableBuilder.AddTable<User>(x => x.Id, keyAutoGenerated: true).AddFieldsAsColumns<User>().DbName("USERS");
            table.Column<User>(x => x.UserTypeId).DbName("USER_TYPE_ID");
            var table2 = tableBuilder.AddTable<UserNullableRecord>(x => x.Id, keyAutoGenerated: true).AddFieldsAsColumns<UserNullableRecord>().DbName("USERS");
            table2.Column<UserNullableRecord>(x => x.UserTypeId).DbName("USER_TYPE_ID");
            var table3 = tableBuilder.AddTable<UserNullableClass>(x => x.Id, keyAutoGenerated: true).AddFieldsAsColumns<UserNullableClass>().DbName("USERS");
            table3.Column<UserNullableClass>(x => x.UserTypeId).DbName("USER_TYPE_ID");
            tableBuilder.AddTable<UserType>(x => x.Id, keyAutoGenerated: false).AddFieldsAsColumns<UserType>().DbName("USER_TYPE");
            DbHub.AddDbBuilder(tableBuilder);
            DbConfig.Register(new DbSettings("db1", SqlProvider.SqlServer, ConnectionString));
            CreateAndPopulateTable();
        }

        #region first time call to database
        [Test, Order(1)]
        public void FetchUsersFromDbAndSaveInCache()
        {
            var dbContext = CachedDbHub.Use("db1"); // Ensure CachedDbHub is in the correct namespace
            var users = dbContext.FetchList<User>();
            Assert.That(users.Count, Is.EqualTo(13));
        }

        [Test, Order(2)]
        [TestCase(1)]
        [TestCase(2)]
        [TestCase(3)]
        public void FetchUserUserFromDbAndSaveInCache(int id)
        {
            var dbContext = CachedDbHub.Use("db1");
            var users = dbContext.FetchList<User>(x => x.Id == id);
            Assert.That(users.Count, Is.EqualTo(1));
        }

        [Test, Order(3)]
        public void FetchTupleFromDbAndSaveInCache()
        {
            var dbContext = CachedDbHub.Use("db1");
            var users = dbContext.FetchTuple<User, User>("SELECT * FROM USERS; SELECT * FROM USERS");
            Assert.That(users.Item1.Count, Is.EqualTo(13));
            Assert.That(users.Item2.Count, Is.EqualTo(13));
        }

        [Test, Order(4)]
        public void FetchUserFromDbByKeyAndSaveInCache()
        {
            var filter = "Sample 1";
            var user = CachedDbHub.Use("db1").FetchOne<User>(x => x.Name == filter, key: "FILTER_1");
            Assert.That(user.Name, Is.EqualTo(filter));
        }

        [Test, Order(5)]
        public void FetchUsersFromDbByKeyAndSaveInCache()
        {
            var users = CachedDbHub.Use("db1").FetchList<UserNullableRecord>(x => x.Birthday == null, key: "FILTER_2");
            Assert.That(users.Count, Is.EqualTo(13));
        }

        const string Tuple2Query = "SELECT * FROM USERS WHERE ID > @user_id; SELECT * FROM USERS WHERE Name like CONCAT('%',@filter_name,'%')";
        [Test, Order(6)]
        public void FetchTupleFromDbByKeyAndSaveInCache()
        {
            var tuple = CachedDbHub.Use("db1").FetchTuple<UserNullableRecord, UserNullableRecord>(Tuple2Query, new { user_id = 0, filter_name = "sample" }, key: "FILTER_3");
            Assert.That(tuple.Item1.Count, Is.EqualTo(13));
            Assert.That(tuple.Item2.Count, Is.EqualTo(13));
        }

        const string Tuple3Query = "SELECT * FROM USERS WHERE ID > @user_id; SELECT * FROM USERS WHERE Name like CONCAT('%',@filter_name,'%'); SELECT * FROM USERS WHERE ID > @user_id";
        [Test, Order(7)]
        public void FetchTuple3FromDbByKeyAndSaveInCache()
        {
            var tuple = CachedDbHub.Use("db1").FetchTuple<UserNullableRecord, UserNullableRecord, UserNullableRecord>(Tuple3Query, new { user_id = 0, filter_name = "sample" }, key: "FILTER_4");
            Assert.That(tuple.Item1.Count, Is.EqualTo(13));
            Assert.That(tuple.Item2.Count, Is.EqualTo(13));
            Assert.That(tuple.Item3.Count, Is.EqualTo(13));
        }
        #endregion

        [Test, CancelAfter(5), Order(8)]
        public void FetchListUsersFromCache()
        {
            var users = CachedDbHub.Use("db1").FetchList<User>();
            Assert.That(users.Count, Is.EqualTo(13));
        }

        [Test, CancelAfter(3), Order(8)]
        [TestCase(1)]
        [TestCase(2)]
        [TestCase(3)]
        public void FetchListUserFromCache(int id)
        {
            var users = CachedDbHub.Use("db1").FetchList<User>(x => x.Id == id);
            Assert.That(users.Count, Is.EqualTo(1));
        }

        [Test, CancelAfter(3), Order(8)]
        public void FetchTupleFromCache()
        {
            var users = CachedDbHub.Use("db1").FetchTuple<User, User>("SELECT * FROM USERS; SELECT * FROM USERS");
            Assert.That(users.Item1.Count, Is.EqualTo(13));
            Assert.That(users.Item2.Count, Is.EqualTo(13));
        }

        [Test, CancelAfter(3), Order(8)]
        public void FetchUserFromCacheByKey()
        {
            var filter = "Sample 1";
            var user = CachedDbHub.Use("db1").FetchOne<User>(x => x.Name == filter, key: "FILTER_1");
            Assert.That(user.Name, Is.EqualTo(filter));
        }

        [Test, CancelAfter(3), Order(8)]
        public void FetchTuple3FromCache()
        {
            var tuple = CachedDbHub.Use("db1").FetchTuple<UserNullableRecord, UserNullableRecord, UserNullableRecord>(Tuple3Query, new { user_id = 0, filter_name = "sample" }, key: "FILTER_4");
            Assert.That(tuple.Item1.Count, Is.EqualTo(13));
            Assert.That(tuple.Item2.Count, Is.EqualTo(13));
            Assert.That(tuple.Item3.Count, Is.EqualTo(13));
        }

        [Test, CancelAfter(3), Order(8)]
        public void FetchUsersFromCacheByKey()
        {
            var users = CachedDbHub.Use("db1").FetchList<UserNullableRecord>(x => x.Birthday == null, key: "FILTER_2");
            Assert.That(users.Count, Is.EqualTo(13));
        }

        [Test, CancelAfter(3), Order(8)]
        public void FetchTupleFromCacheByKey()
        {
            var users = CachedDbHub.Use("db1").FetchTuple<UserNullableRecord, UserNullableRecord>(Tuple2Query, new { user_id = 0, filter_name = "sample" }, key: "FILTER_3");
            Assert.That(users.Item1.Count, Is.EqualTo(13));
            Assert.That(users.Item2.Count, Is.EqualTo(13));
        }

        [Test, Order(9)]
        [TestCase("FILTER_1")]
        [TestCase("FILTER_2")]
        [TestCase("FILTER_3")]
        [TestCase("FILTER_4")]
        public void RefreshByKey(string key)
        {
            CachedDbHub.Use("db1").Refresh(key, throwErrorIfNotFound: true);
            Assert.Pass();
        }

        [Test, Order(10)]
        [TestCase("FILTER_1")]
        [TestCase("FILTER_2")]
        [TestCase("FILTER_3")]
        [TestCase("FILTER_4")]
        public void ClearByKey(string key)
        {
            CachedDbHub.Use("db1").Clear(key);
            Assert.Pass();
        }

        [Test, Order(8)]
        [TestCase("FILTER_INVALID_1")]
        [TestCase("FILTER_INVALID_2")]
        public void SafeClearInvalidKey(string key)
        {
            var dbContext = CachedDbHub.Use("db1");
            dbContext.Clear(key);
            Assert.Throws<KeyNotFoundException>(() => dbContext.Refresh(key, throwErrorIfNotFound: true));
        }

        [OneTimeTearDown]
        public void ClearAll()
        {
            CachedDbHub.Clear();
        }
    }
}
